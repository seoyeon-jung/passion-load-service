generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum SessionStatus {
  PLANNED
  ACTIVE
  DONE
}

enum AssignmentType {
  TASK
  DAILY_CHECK
}

enum DailyAssignmentStatus {
  SCHEDULED
  COMPLETED
  INCOMPLETE
}

enum SubmissionStatus {
  NOT_STARTED
  IN_PROGRESS
  DONE
  HOLD
}

model Session {
  id             String        @id @default(uuid()) @db.Uuid
  organizationId String        @map("organization_id") @db.Uuid
  teacherId      String?       @map("teacher_id") @db.Uuid
  title          String
  sessionDate    DateTime      @map("session_date")
  status         SessionStatus @default(PLANNED)
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  assignments    DailyAssignment[]

  @@index([organizationId])
  @@index([sessionDate])
  @@map("sessions")
}

model DailyAssignment {
  id String @id @default(uuid()) @db.Uuid

  organizationId String  @map("organization_id") @db.Uuid
  sessionId      String? @map("session_id") @db.Uuid
  studentId      String  @map("student_id") @db.Uuid

  assignmentDate DateTime       @map("assignment_date") @db.Date
  assignmentType AssignmentType @map("assignment_type")

  // TASK
  title              String?
  body               String?               @db.Text
  dueAt              DateTime?             @map("due_at")
  status             DailyAssignmentStatus @default(SCHEDULED)
  incompletionReason String?               @map("incompletion_reason") @db.Text

  subject          String?
  categoryType     String? @map("category_type")
  difficulty       String?
  estimatedMinutes Int?    @map("estimated_minutes")

  // DAILY_CHECK
  checked     Boolean @default(false)
  contactMade Boolean @default(false) @map("contact_made")
  checkMemo   String? @map("check_memo") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  session Session? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  submissions AssignmentSubmission[]
  feedbacks   Feedback[]

  @@index([organizationId])
  @@index([sessionId])
  @@index([studentId, assignmentDate])
  @@index([assignmentType, assignmentDate])
  @@map("daily_assignments")
}

model AssignmentSubmission {
  id             String           @id @default(uuid()) @db.Uuid
  organizationId String           @map("organization_id") @db.Uuid
  assignmentId   String           @map("assignment_id") @db.Uuid
  studentId      String           @map("student_id") @db.Uuid
  status         SubmissionStatus @default(NOT_STARTED)
  reason         String?
  scheduleNote   String?          @map("schedule_note")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  assignment DailyAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, studentId])
  @@index([organizationId])
  @@index([studentId])
  @@map("assignment_submissions")
}

model Feedback {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  studentId      String   @map("student_id") @db.Uuid
  assignmentId   String?  @map("assignment_id") @db.Uuid
  content        String
  createdAt      DateTime @default(now()) @map("created_at")

  assignment DailyAssignment? @relation(fields: [assignmentId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([studentId])
  @@index([assignmentId])
  @@map("feedbacks")
}

model Report {
  id              String   @id @default(uuid())
  organizationId  String   @map("organization_id")
  createdBy       String?  @map("created_by")
  fromDate        DateTime @map("from_date")
  toDate          DateTime @map("to_date")
  targetStudentId String?  @map("target_student_id")
  url             String?
  metadata        Json?
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([organizationId])
  @@index([fromDate, toDate])
  @@index([targetStudentId])
  @@map("reports")
}
