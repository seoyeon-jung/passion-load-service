generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum SessionStatus {
  PLANNED
  ACTIVE
  DONE
}

enum AssignmentType {
  TASK
  DAILY_CHECK
}

enum SubmissionStatus {
  NOT_STARTED
  IN_PROGRESS
  DONE
  HOLD
}

model Session {
  id             String        @id @default(uuid())
  organizationId String        @map("organization_id")
  teacherId      String?       @map("teacher_id")
  title          String
  sessionDate    DateTime      @map("session_date")
  status         SessionStatus @default(PLANNED)
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  assignments DailyAssignment[]

  @@index([organizationId])
  @@index([sessionDate])
  @@map("sessions")
}

model DailyAssignment {
  id             String         @id @default(uuid())
  organizationId String         @map("organization_id")
  sessionId      String?        @map("session_id")
  studentId      String         @map("student_id")
  date           DateTime
  type           AssignmentType @map("assignment_type")
  title          String?
  content        String?
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  session     Session?                 @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  submissions AssignmentSubmission[]
  feedbacks   Feedback[]

  @@index([organizationId])
  @@index([studentId, date])
  @@index([sessionId])
  @@map("daily_assignments")
}

model AssignmentSubmission {
  id             String           @id @default(uuid())
  organizationId String           @map("organization_id")
  assignmentId   String           @map("assignment_id")
  studentId      String           @map("student_id")
  status         SubmissionStatus @default(NOT_STARTED)
  reason         String?
  scheduleNote   String?          @map("schedule_note")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  assignment DailyAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, studentId]) // upsert 키
  @@index([organizationId])
  @@index([studentId])
  @@map("assignment_submissions")
}

model Feedback {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  studentId      String   @map("student_id")
  assignmentId   String?  @map("assignment_id")
  content        String   // 250자 제한은 앱 레벨 검증
  createdAt      DateTime @default(now()) @map("created_at")

  assignment DailyAssignment? @relation(fields: [assignmentId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([studentId])
  @@index([assignmentId])
  @@map("feedbacks")
}

model Report {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  createdBy      String?  @map("created_by")
  fromDate       DateTime @map("from_date")
  toDate         DateTime @map("to_date")
  targetStudentId String? @map("target_student_id")
  url            String?
  metadata       Json?
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([organizationId])
  @@index([fromDate, toDate])
  @@index([targetStudentId])
  @@map("reports")
}